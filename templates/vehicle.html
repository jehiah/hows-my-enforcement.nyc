<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon_96.png">
    <title>How is NYC Parking Enforcement?</title>
        
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.3/dist/d3.min.js" integrity="sha256-z9jvEmgHGEfWO4rPfEXUGKFd6UkxkavfJ0zf3qT31O4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js" integrity="sha256-nP25Pzivzy0Har7NZtMr/TODzfGWdlTrwmomYF2vQXM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js" integrity="sha256-qDfIIxqpRhYWa543p6AHZ323xT3B8O6iLZFUAWtEQJw=" crossorigin="anonymous"></script>    

<style>
    body {
        background-color:#ffd900;
    }
    .table-xsm {
        font-size:80%;
    }
    .table-xsm>:not(caption)>*>* {
        padding: 0.1rem 0.1rem;
    }
    .summary {
        line-height: 1.7rem;
    }
    footer {
    text-align: center;
    font-size: .75rem;
    color: #999;
    padding: 2rem 1rem;
    }
    footer a:link, footer a:visited {
    color: #777;
    }
    footer p {
    margin-bottom: .5rem;
    }
    .table-striped>tbody>tr.non-parking-violation > td {
        color:#999;
    }
    h1 > a {
        text-decoration: none;
        color:inherit;
    }
    h1 > a:hover {
        text-decoration: underline;
        color:inherit;
    }
    .table>thead>tr>th:first-child, .table>tbody>tr>td:first-child {
        padding-left: .5rem;
    }
    h3 {
    color: #666;
    font-family: ui-serif;
    text-transform: uppercase;
    font-size: 1.25em;
    border-bottom: 1px solid #666;
    background-color: #f9f9f9;
    margin-bottom:0;
}

    .agency { display: none;}
    @media (min-width: 768px) { 
        .agency { display: table-cell; }
    }
    .render mark {
        white-space: nowrap;
    }
    .tooltip {
        background-color: #fff;
        border-color: #777;
        border-radius: 3px;
        font-size: .8rem;
    }
    rect.cell.highlighted {
        stroke: #000;
    }
</style>
</head>
<body>

<div class="container mt-2 mt-lg-3 mt-xl-5 px-3">

    <div class="row">
        <div class="col-12 col-lg-10 col-xl-8">
        <h1><a href="/">How is NYC Parking Enforcement?</a></h1>
        <p class="hide-render">Is NYPD Traffic's parking enforcement consistent and rigorous on your block? <a href="/">Check</a>!</p>
        <p class="fw-light hide-render">Enforcement of parking regulations should be consistent and rigorous.</p>
        </div>
    </div>

    <div class="row">

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <span class="nav-link disabled">Search By:</span>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/">Street</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/precinct">Precinct</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/summons">Summons</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/vehicle">Vehicle</a>
            </li>
        </ul>
        
    </div>

    <div class="row mt-3">
        <div class="col-12 col-lg-8 bg-white rounded-3 pt-2">
            <h2>License Plate</h2>

            <div class="input-group mb-3">
                <input type="text" class="form-control" id="license_plate" value="{{.Plate}}" placeholder="License Plate" aria-label="License plate number">
                <select class="form-select" id="license_state" aria-label="Plate state" data-default-state="{{.State}}">
                    <option value="AL">AL - Alabama</option>
                    <option value="AK">AK - Alaska</option>
                    <option value="AZ">AZ - Arizona</option>
                    <option value="AR">AR - Arkansas</option>
                    <option value="CA">CA - California</option>
                    <option value="CO">CO - Colorado</option>
                    <option value="CT">CT - Connecticut</option>
                    <option value="DE">DE - Delaware</option>
                    <option value="DC">DC - District of Columbia</option>
                    <option value="FL">FL - Florida</option>
                    <option value="GA">GA - Georgia</option>
                    <option value="HI">HI - Hawaii</option>
                    <option value="ID">ID - Idaho</option>
                    <option value="IL">IL - Illinois</option>
                    <option value="IN">IN - Indiana</option>
                    <option value="IA">IA - Iowa</option>
                    <option value="KS">KS - Kansas</option>
                    <option value="KY">KY - Kentucky</option>
                    <option value="LA">LA - Louisiana</option>
                    <option value="ME">ME - Maine</option>
                    <option value="MD">MD - Maryland</option>
                    <option value="MA">MA - Massachusetts</option>
                    <option value="MI">MI - Michigan</option>
                    <option value="MN">MN - Minnesota</option>
                    <option value="MS">MS - Mississippi</option>
                    <option value="MO">MO - Missouri</option>
                    <option value="MT">MT - Montana</option>
                    <option value="NE">NE - Nebraska</option>
                    <option value="NV">NV - Nevada</option>
                    <option value="NH">NH - New Hampshire</option>
                    <option value="NJ">NJ - New Jersey</option>
                    <option value="NM">NM - New Mexico</option>
                    <option value="NY" selected>NY - New York</option>
                    <option value="NC">NC - North Carolina</option>
                    <option value="ND">ND - North Dakota</option>
                    <option value="OH">OH - Ohio</option>
                    <option value="OK">OK - Oklahoma</option>
                    <option value="OR">OR - Oregon</option>
                    <option value="PA">PA - Pennsylvania</option>
                    <option value="RI">RI - Rhode Island</option>
                    <option value="SC">SC - South Carolina</option>
                    <option value="SD">SD - South Dakota</option>
                    <option value="TN">TN - Tennessee</option>
                    <option value="TX">TX - Texas</option>
                    <option value="UT">UT - Utah</option>
                    <option value="VT">VT - Vermont</option>
                    <option value="VA">VA - Virginia</option>
                    <option value="WA">WA - Washington</option>
                    <option value="WV">WV - West Virginia</option>
                    <option value="WI">WI - Wisconsin</option>
                    <option value="WY">WY - Wyoming</option>
                    <option value="ON">ON - Ontario</option>
                    <option value="QC">QC - Quebec</option>
                </select>
                <button id="query-button" type="button" class="btn btn-info">Search</button>
            </div>
            <p class="text-muted small">Enter the vehicle plate and state to see parking and camera violations and NYPD moving violations (B Summons) for that plate.</p>
        </div>
    </div>

    <div id="report-data" class="row mb-5"></div>

    <div class="row mb-2 text-muted fw-light">
        <div class="col-lg-8">
            <p>Parking and moving violation data is queried directly from NYC Open Data; delays before a summons appears vary by agency and violation type.</p>
        </div>
    </div>
    <div class="row">
        <footer>
            <p>Made with ❤️ by <a href="https://jehiah.cz/">@jehiah</a>.</p>
            <p>Data from NYC Open Data:
                <a href="https://data.cityofnewyork.us/City-Government/Open-Parking-and-Camera-Violations/nc67-uf89/about_data">Open Parking and Camera Violations</a>
                <a href="https://data.cityofnewyork.us/browse?Data-Collection_Data-Collection=DOF+Parking+Violations+Issued&q=&sortBy=alpha&utf8=%E2%9C%93&page=1&pageSize=20">Parking Violations Issued by Fiscal Year</a>
                <a href="https://data.cityofnewyork.us/Public-Safety/Moving-Violation-B-Summons-Historic-/bme5-7ty4/about_data">Moving Violation B Summons (Historic)</a>.
                <a href="https://data.cityofnewyork.us/Public-Safety/Moving-Violation-B-Summons-Year-to-Date-/57p3-pdcj/">Moving Violation B Summons Year to Date</a>.
            </p>
        </footer>
    </div>

</div>


<script type="module">

const parseDate = d3.utcParse("%Y-%m-%d")
const FYLookup = {
  "FY2024": {
    "dataset":"pvqr-7yc4", 
    "start": parseDate("2023-07-01"),
    "end": {
        "P":parseDate("2025-05-13"),
        "T":parseDate("2025-05-17"),
        "S":parseDate("2025-05-29")
    }
  },
  "FY2023": {
    "dataset":"869v-vr48", 
    "start": parseDate("2022-07-01"),
    "end": parseDate("2023-06-30")
  },
}
const FY = FYLookup["FY2024"]

const ViolationCodes = {
    "1":"FAILURE TO DISPLAY BUS PERMIT",
    "2":"NO OPERATOR NAM/ADD/PH DISPLAY",
    "3":"UNAUTHORIZED PASSENGER PICK-UP",
    "4":"BUS PARKING IN LOWER MANHATTAN",
    "5":"BUS LANE VIOLATION",
    "6":"OVERNIGHT TRACTOR TRAILER PKG",
    "7":"FAILURE TO STOP AT RED LIGHT",
    "8":"IDLING",
    "9":"OBSTRUCTING TRAFFIC/INTERSECT",
    "10":"NO STOPPING-DAY/TIME LIMITS",
    "11":"NO STANDING-HOTEL LOADING",
    "12":"MOBILE BUS LANE VIOLATION",
    "13":"NO STANDING-TAXI STAND",
    "14":"NO STANDING-DAY/TIME LIMITS",
    "15":"MTA CAMERA DOUBLE PARKING",
    "16":"NO STANDING-EXC. TRUCK LOADING",
    "17":"NO STANDING-EXC. AUTH. VEHICLE",
    "18":"NO STANDING-BUS LANE",
    "19":"NO STANDING-BUS STOP",
    "20":"NO PARKING-DAY/TIME LIMITS",
    "21":"NO PARKING-STREET CLEANING",
    "22":"NO STAND TAXI/FHV RELIEF STAND",
    "23":"NO PARKING-TAXI STAND",
    "24":"NO PARKING-EXC. AUTH. VEHICLE",
    "25":"NO STANDING-COMMUTER VAN STOP",
    "26":"NO STANDING-FOR HIRE VEH STND",
    "27":"NO PARKING-EXC. DSBLTY PERMIT",
    "28":"OVERTIME STANDING DP",
    "29":"ALTERING INTERCITY BUS PERMIT",
    "30":"NO STOP/STANDNG EXCEPT PAS P/U",
    "31":"NO STANDING-COMM METER ZONE",
    "32":"OT PARKING-MISSING/BROKEN METR",
    "33":"MISUSE PARKING PERMIT",
    "34":"EXPIRED METER",
    "35":"SELLING/OFFERING MCHNDSE-METER",
    "36":"PHTO SCHOOL ZN SPEED VIOLATION",
    "37":"EXPIRED MUNI METER",
    "38":"FAIL TO DSPLY MUNI METER RECPT",
    "39":"OVERTIME PKG-TIME LIMIT POSTED",
    "40":"FIRE HYDRANT",
    "41":"MISCELLANEOUS",
    "42":"EXPIRED MUNI MTR-COMM MTR ZN",
    "43":"MTA CAMERA BUS STOP",
    "44":"PKG IN EXC. OF LIM-COMM MTR ZN",
    "45":"TRAFFIC LANE",
    "46":"DOUBLE PARKING",
    "47":"DOUBLE PARKING-MIDTOWN COMML",
    "48":"BIKE LANE",
    "49":"EXCAVATION-VEHICLE OBSTR TRAFF",
    "50":"CROSSWALK",
    "51":"SIDEWALK",
    "52":"INTERSECTION",
    "53":"SAFETY ZONE",
    "54":"PCKP DSCHRGE IN PRHBTD ZONE",
    "55":"ELEVATED/DIVIDED HIGHWAY/TUNNL",
    "56":"DIVIDED HIGHWAY",
    "57":"WEIGH IN MOTION VIOLATION",
    "58":"MARGINAL STREET/WATER FRONT",
    "59":"ANGLE PARKING-COMM VEHICLE",
    "60":"ANGLE PARKING",
    "61":"WRONG WAY",
    "62":"BEYOND MARKED SPACE",
    "63":"NIGHTTIME STD/ PKG IN A PARK",
    "64":"NO STANDING EXCP D/S",
    "65":"OVERTIME STDG D/S",
    "66":"DETACHED TRAILER",
    "67":"PEDESTRIAN RAMP",
    "68":"NON-COMPLIANCE W/ POSTED SIGN",
    "69":"FAIL TO DISP. MUNI METER RECPT",
    "70":"REG. STICKER-EXPIRED/MISSING",
    "71":"INSP. STICKER-EXPIRED/MISSING",
    "72":"INSP STICKER-MUTILATED/C'FEIT",
    "73":"REG STICKER-MUTILATED/C'FEIT",
    "74":"FRONT OR BACK PLATE MISSING",
    "75":"NO MATCH-PLATE/STICKER",
    "76":"VIN OBSCURED",
    "77":"PARKED BUS-EXC. DESIG. AREA",
    "78":"NGHT PKG ON RESID STR-COMM VEH",
    "79":"UNAUTHORIZED BUS LAYOVER",
    "80":"MISSING EQUIPMENT",
    "81":"NO STANDING EXCP DP",
    "82":"COMML PLATES-UNALTERED VEHICLE",
    "83":"IMPROPER REGISTRATION",
    "84":"PLTFRM LFTS LWRD POS COMM VEH",
    "85":"STORAGE-3HR COMMERCIAL",
    "86":"MIDTOWN PKG OR STD-3HR LIMIT",
    "87":"FRAUDULENT USE PARKING PERMIT",
    "88":"UNALTERED COMM VEH-NME/ADDRESS",
    "89":"NO STD(EXC TRKS/GMTDST NO-TRK)",
    "90":"VEH-SALE/WSHNG/RPRNG/DRIVEWAY",
    "91":"VEHICLE FOR SALE(DEALERS ONLY)",
    "92":"WASH/REPAIR VEHCL-REPAIR ONLY",
    "93":"REMOVE/REPLACE FLAT TIRE",
    "96":"RAILROAD CROSSING",
    "97":"VACANT LOT",
    "98":"OBSTRUCTING DRIVEWAY",
    "99":"OTHER"
}
const nonParkingViolations = new Set([
    "3", "7", "8", "29", "33", "36", "41", "54", "70","71", "72", "73", "74", "75", "76", "80", "82", "83", "84", "87", "88", "91", "97", "99"
])

const agencyLookup = {
    "P": "Police Department",
    "T": "Traffic",
    "S": "Sanitation",
    "K": "Parks",
}

const dtFormat = new Intl.DateTimeFormat("en-US")
const dtFormatDateTime = new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "numeric",
    day: "numeric",
    hour: "numeric",
    minute: "numeric",
    hour12: true,
    timeZone: "UTC"
})

const MOVING_DATASET_CURRENTYEAR_ID = "57p3-pdcj"
const MOVING_DATASET_HISTORIC_ID = "bme5-7ty4"
const MOVING_DATASET_CURRENTYEAR_BASE = `https://data.cityofnewyork.us/resource/${MOVING_DATASET_CURRENTYEAR_ID}.json`
const MOVING_DATASET_HISTORIC_BASE = `https://data.cityofnewyork.us/resource/${MOVING_DATASET_HISTORIC_ID}.json`
const MOVING_DATASET_ABOUT = "https://data.cityofnewyork.us/Public-Safety/Moving-Violation-B-Summons-Year-to-Date-/57p3-pdcj/"
const MOVING_LOOKUP_URL = "/static/violation_code_lookup_q16189a3.csv"
const movingViolationLookup = {}
let movingViolationLookupPromise = null

dayjs.extend(dayjs_plugin_utc)

const licensePlateInput = document.getElementById("license_plate")
const licenseStateSelect = document.getElementById("license_state")
const queryButton = document.getElementById("query-button")
const reportContainer = document.getElementById("report-data")

function normalizeStateOrPlate(value) {
    if (!value) {
        return ""
    }
    return String(value).trim().toUpperCase().replace(/[^A-Z0-9]/g, "")
}

function resolveStateValue(value, fallback = "") {
    const normalized = value ? String(value).trim().toUpperCase() : ""
    return normalized || (fallback ? String(fallback).trim().toUpperCase() : "")
}

function buildMovingLookupKey(lawTitle, adjCode) {
    const normalizedTitle = (lawTitle || "").trim().toUpperCase()
    const normalizedAdjCode = (adjCode || "").trim()
    if (normalizedTitle === "" || normalizedAdjCode === "") {
        return null
    }
    return `${normalizedTitle}::${normalizedAdjCode}`
}

function loadMovingViolationLookup() {
    if (!movingViolationLookupPromise) {
        movingViolationLookupPromise = fetch(MOVING_LOOKUP_URL)
            .then(response => response.text())
            .then(text => {
                d3.csvParse(text).forEach(row => {
                    const key = buildMovingLookupKey(row.LawTitle, row.AdjCode)
                    if (key) {
                        movingViolationLookup[key] = {
                            lawCode: row.LawCode || "",
                            description: row.Description || ""
                        }
                    }
                })
                return movingViolationLookup
            })
            .catch(err => {
                console.error("Unable to load moving violation lookup", err)
                return movingViolationLookup
            })
    }
    return movingViolationLookupPromise
}

function getMovingViolationMetadata(lawTitle, adjCode) {
    const key = buildMovingLookupKey(lawTitle, adjCode)
    return key ? movingViolationLookup[key] : undefined
}

function getParkingData(plate, state) {
    const filters = [
        `plate_id='${plate}'`,
        `registration_state='${state}'`
    ]
    const query = `&$where=${filters.join(" AND ")}`
    return Promise.all([
        fetch(`https://data.cityofnewyork.us/resource/${FYLookup["FY2024"].dataset}.csv?$select=plate_id,registration_state,violation_code,issuing_agency,issue_date,street_name,house_number,intersecting_street,violation_time,summons_number&$limit=100000${query}`),
        fetch(`https://data.cityofnewyork.us/resource/${FYLookup["FY2023"].dataset}.csv?$select=plate_id,registration_state,violation_code,issuing_agency,issue_date,street_name,house_number,intersecting_street,violation_time,summons_number&$limit=100000${query}`)
    ])
    .then(results => Promise.all(results.map(r => r.text())))
    .then(([current, prior]) => {
        const parsed = d3.csvParse(current)
        parsed.push(...d3.csvParse(prior))
        return parsed
    })
}

function getMovingViolations(plate, state) {
    const filters = [`reg_plate_num='${normalizeStateOrPlate(plate)}'`]
    filters.push(`reg_state_cd='${normalizeStateOrPlate(state)}'`)
    const params = new URLSearchParams({
        "$select": "violation_date,violation_time,chg_law_cd,violation_code,veh_category,reg_plate_num,reg_state_cd,city_nm,rpt_owning_cmd,juris_cd",
        "$limit": "5000",
        "$where": filters.join(" AND ")
    })
    const query = params.toString()
    return Promise.all([
        fetch(`${MOVING_DATASET_CURRENTYEAR_BASE}?${query}`).then(response => response.json()),
        fetch(`${MOVING_DATASET_HISTORIC_BASE}?${query}`).then(response => response.json())
    ]).then(([current, historic]) => {
        const currentArray = Array.isArray(current) ? current : []
        const historicArray = Array.isArray(historic) ? historic : []
        return currentArray.concat(historicArray)
    })
}

function renderParkingViolations(container, records, plate, state) {
    const parseDateTime = d3.utcParse("%Y-%m-%dT%H:%M:%S.%L")
    const parseTime = d3.utcParse("%I%M%p")
    const dtFormatHour = new Intl.DateTimeFormat("en-US", {
        hour: "numeric",
        minute: "numeric",
        hour12: true,
        timeZone: "UTC",
    })
    records.forEach(d => {
        d.issue_date = parseDateTime(d.issue_date)
        d.count = 1
        const violation_time = parseTime(d.violation_time + "M")
        if (violation_time) {
            d.issue_date.setUTCHours(violation_time.getUTCHours())
            d.issue_date.setUTCMinutes(violation_time.getUTCMinutes())
            d.violation_time = dtFormatHour.format(d.issue_date)
        }
    })

    const seenSummons = new Set()
    const filtered = records.filter(d => {
        const key = d.summons_number + ' ' +  d.violation_code
        if (seenSummons.has(key)) { return false }
        seenSummons.add(key)
        return true
    })

    const heading = container.appendChild(document.createElement("h3"))
    heading.innerText = "Parking and Camera Violations"

    if (filtered.length === 0) {
        const empty = document.createElement("p")
        empty.className = "summary"
        empty.innerText = `No parking or camera violations found.`
        container.appendChild(empty)
        return
    }



    filtered.sort((a, b) => d3.ascending(a.issue_date, b.issue_date))

    const table = container.appendChild(document.createElement("table"))
    table.className = "table table-sm table-xsm table-striped mb-2 p-2"
    const thead = table.appendChild(document.createElement("thead"))
    const headerRow = thead.appendChild(document.createElement("tr"))
    headerRow.className = "bg-dark text-light"
    headerRow.appendChild(document.createElement("th")).innerText = "Date"
    headerRow.appendChild(document.createElement("th")).innerText = "Summons"
    headerRow.appendChild(document.createElement("th")).innerText = "License"
    headerRow.appendChild(document.createElement("th")).innerText = "Location"
    const agencyCell = headerRow.appendChild(document.createElement("th"))
    agencyCell.className =  "agency"
    agencyCell.innerText = "Agency"
    headerRow.appendChild(document.createElement("th")).innerText = "Violation"

    const tbody = table.appendChild(document.createElement("tbody"))
    filtered.forEach(d => {
        const tr = tbody.appendChild(document.createElement("tr"))
        tr.className = nonParkingViolations.has(d.violation_code) ? "non-parking-violation" : "parking-violation"
        tr.appendChild(document.createElement("td")).innerText = dtFormat.format(d.issue_date) + " " + d.violation_time
        const summonsCell = tr.appendChild(document.createElement("td"))
        summonsCell.className = "summons font-monospace"
        const a = summonsCell.appendChild(document.createElement("a"))
        a.href = "/summons?" + (new URLSearchParams({"number": d.summons_number})).toString()
        a.rel = "nofollow"
        a.innerText = d.summons_number

        const licenseCell = tr.appendChild(document.createElement("td"))
        licenseCell.className = "font-monospace"
        licenseCell.innerText = d.registration_state + ":" + d.plate_id
        tr.appendChild(document.createElement("td")).innerText = d.house_number + ' ' + d.street_name + (d.intersecting_street === "" ? "" : " @ " + d.intersecting_street)
        const agencyCellRow = tr.appendChild(document.createElement("td"))
        agencyCellRow.className = "agency"
        agencyCellRow.innerText = agencyLookup[d.issuing_agency]
        tr.appendChild(document.createElement("td")).innerText = ViolationCodes[d.violation_code]
    })
    container.appendChild(table)

}


function renderMovingViolations(container, records, plate, state) {
    const section = container.appendChild(document.createElement("div"))
    section.className = "mt-4"
    const heading = section.appendChild(document.createElement("h3"))
    heading.innerText = "Moving violations (B Summons)"
    if (records.length === 0) {
        const empty = section.appendChild(document.createElement("p"))
        empty.className = "summary"
        empty.innerText = `No moving violations found.`
        return
    }

    const parseDateTime = d3.utcParse("%Y-%m-%dT%H:%M:%S.%L")
    records.forEach(row => {
        row.violation_dt = parseDateTime(row.violation_date)
        if (row.violation_dt && row.violation_time) {
            const [hours, minutes] = row.violation_time.split(":")
            if (hours !== undefined && minutes !== undefined) {
                row.violation_dt.setUTCHours(parseInt(hours, 10))
                row.violation_dt.setUTCMinutes(parseInt(minutes, 10))
            }
        }
    })
    records.sort((a, b) => d3.descending(a.violation_dt || 0, b.violation_dt || 0))

    const table = section.appendChild(document.createElement("table"))
    table.className = "table table-sm table-xsm table-striped mb-2 p-2"
    const thead = table.appendChild(document.createElement("thead"))
    const tr = thead.appendChild(document.createElement("tr"))
    tr.className = "bg-dark text-light"
    tr.appendChild(document.createElement("th")).innerText = "Date"
    tr.appendChild(document.createElement("th")).innerText = "Violation"
    tr.appendChild(document.createElement("th")).innerText = "Law Code"
    tr.appendChild(document.createElement("th")).innerText = "Description"
    tr.appendChild(document.createElement("th")).innerText = "Vehicle"
    tr.appendChild(document.createElement("th")).innerText = "City / Command"
    tr.appendChild(document.createElement("th")).innerText = "Jurisdiction"

    const tbody = table.appendChild(document.createElement("tbody"))
    records.forEach(row => {
        const dataRow = tbody.appendChild(document.createElement("tr"))
        dataRow.appendChild(document.createElement("td")).innerText =  dtFormatDateTime.format(row.violation_dt) 
        const violationCell = dataRow.appendChild(document.createElement("td"))
        const lookupEntry = getMovingViolationMetadata(row.chg_law_cd, row.violation_code)
        violationCell.innerText = `${row.chg_law_cd} ${lookupEntry.lawCode ? lookupEntry.lawCode : row.violation_code}`

        const lawCodeCell = dataRow.appendChild(document.createElement("td"))
        lawCodeCell.className = "font-monospace"
        lawCodeCell.innerText = lookupEntry && lookupEntry.lawCode ? lookupEntry.lawCode : "—"

        const descriptionCell = dataRow.appendChild(document.createElement("td"))
        descriptionCell.innerText = lookupEntry && lookupEntry.description ? lookupEntry.description : "—"

        const vehicleCell = dataRow.appendChild(document.createElement("td"))
        let vehicleLabel = row.reg_state_cd && row.reg_plate_num ? `${row.reg_state_cd}:${row.reg_plate_num}` : `${state}:${plate}`
        if (row.veh_category) {
            vehicleLabel += ` (${row.veh_category})`
        }
        vehicleCell.innerText = vehicleLabel

        const cityParts = []
        if (row.city_nm) {
            cityParts.push(row.city_nm)
        }
        if (row.rpt_owning_cmd) {
            cityParts.push(row.rpt_owning_cmd)
        }
        dataRow.appendChild(document.createElement("td")).innerText = cityParts.length ? cityParts.join(" • ") : "—"
        dataRow.appendChild(document.createElement("td")).innerText = row.juris_cd || "—"
    })

}

function queryVehicleHistory(plateValue, stateValue, updateHistory = true) {
    const normalizedPlate = normalizeStateOrPlate(plateValue)
    const normalizedState = normalizeStateOrPlate(stateValue)
    if (!normalizedPlate ) {
        licensePlateInput.classList.add("is-invalid")
        licensePlateInput.focus()
        return
    }

    licensePlateInput.value = normalizedPlate
    licensePlateInput.classList.remove("is-invalid")

    if (updateHistory) {
        const qs = new URLSearchParams()
        qs.set("plate", normalizedPlate)
        if (normalizedState) {
            qs.set("state", normalizedState)
        }
        history.pushState(null, document.title, window.location.pathname + "?" + qs.toString())
    }

    reportContainer.innerHTML = ''
    const el = document.createElement("div")
    el.className = "col-12 mt-4 mb-2 py-2 bg-white"
    reportContainer.appendChild(el)
    const heading = document.createElement("h2")
    heading.innerText = `Violations for ${normalizedState}:${normalizedPlate}`
    el.appendChild(heading)
    const dateFormat = d3.utcFormat("%Y-%m-%d")

    const spinner = document.createElement("div")
    spinner.className = "spinner-border m-5"
    spinner.setAttribute("role", "status")
    spinner.setAttribute("aria-label", "Searching Parking Violations, Camera Violations, Moving (B Summons) Violations")
    el.appendChild(spinner)

    Promise.all([getParkingData(normalizedPlate, normalizedState), getMovingViolations(normalizedPlate, normalizedState), loadMovingViolationLookup()])
    .then(([parkingViolations, movingViolations]) => {
        spinner.remove()
        renderParkingViolations(el, parkingViolations, normalizedPlate, normalizedState)
        renderMovingViolations(el, movingViolations, normalizedPlate, normalizedState)
    })
    .catch(err => {
        spinner.remove()
        console.error(err)
        const alertBox = document.createElement("div")
        alertBox.className = "alert alert-danger"
        alertBox.innerText = "Unable to fetch vehicle data right now. Please try again."
        el.appendChild(alertBox)
    })
}

function bootstrap() {
    const defaultState = resolveStateValue(licenseStateSelect.dataset.defaultState || "NY", "NY") || "NY"
    licenseStateSelect.value = defaultState
    const params = new URLSearchParams(window.location.search)
    const presetPlate = normalizeStateOrPlate(params.get("plate"))
    const presetState = resolveStateValue(params.get("state"), defaultState)
    if (presetState) {
        licenseStateSelect.value = presetState
    }
    if (presetPlate) {
        licensePlateInput.value = presetPlate
        queryVehicleHistory(presetPlate, licenseStateSelect.value, false)
    }
}

function handleSearch(updateHistory = true) {
    queryVehicleHistory(licensePlateInput.value, licenseStateSelect.value, updateHistory)
}

queryButton.addEventListener("click", () => handleSearch(true))
licensePlateInput.addEventListener("keyup", (event) => {
    if (event.key === "Enter") {
        handleSearch(true)
    }
})
licensePlateInput.addEventListener("input", () => {
    licensePlateInput.classList.remove("is-invalid")
})
licenseStateSelect.addEventListener("change", () => {
    if (normalizeStateOrPlate(licensePlateInput.value)) {
        handleSearch(true)
    }
})

bootstrap()

</script>
</body>
</html>
