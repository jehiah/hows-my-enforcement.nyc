<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon_96.png">
    <title>How is NYC Parking Enforcement?</title>

    <!-- {{ if .Report.PreviewImage }}
    <meta property="og:title" content="How is NYC Parking Enforcement?" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="{{.Report.Description}}" />
    <meta property="og:url" content="https://hows-my-enforcement.nyc{{.Report.Link}}" />
    <meta property="og:image" content="{{.Report.PublicPreview}}" />
    <meta property="og:image:type" content="image/png" />
    {{ end }} -->
        
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.3/dist/d3.min.js" integrity="sha256-z9jvEmgHGEfWO4rPfEXUGKFd6UkxkavfJ0zf3qT31O4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js" integrity="sha256-nP25Pzivzy0Har7NZtMr/TODzfGWdlTrwmomYF2vQXM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js" integrity="sha256-qDfIIxqpRhYWa543p6AHZ323xT3B8O6iLZFUAWtEQJw=" crossorigin="anonymous"></script>    
    <!-- {{ if .SavePreview}}
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha256-6H5VB5QyLldKH9oMFUmjxw2uWpPZETQXpCkBaDjquMs=" crossorigin="anonymous"></script>
    {{ end }} -->

<style>
    body {
        background-color:#ffd900;

    }
    .table-xsm {
        font-size:80%;
    }
    .table-xsm>:not(caption)>*>* {
        padding: 0.1rem 0.1rem;
    }
    .summary {
        line-height: 1.7rem;
    }
    footer {
    text-align: center;
    font-size: .75rem;
    color: #999;
    padding: 2rem 1rem;
    }
    footer a:link, footer a:visited {
    color: #777;
    }
    footer p {
    margin-bottom: .5rem;
    }
    .table-striped>tbody>tr.non-parking-violation > td {
        color:#999;
    }
    h1 > a {
        text-decoration: none;
        color:inherit;
    }
    h1 > a:hover {
        text-decoration: underline;
        color:inherit;
    }
    .table>thead>tr>th:first-child, .table>tbody>tr>td:first-child {
        padding-left: .5rem;
    }

    .agency { display: none;}
    @media (min-width: 768px) { 
        .agency { display: table-cell; }
    }
    .render mark {
        white-space: nowrap;
    }
    .tooltip {
        background-color: #fff;
        border-color: #777;
        border-radius: 3px;
        font-size: .8rem;
    }
    rect.cell.highlighted {
        stroke: #000;
    }
</style>
</head>
<body>

<div class="container mt-2 mt-lg-3 mt-xl-5 px-3">

    <div class="row">
        <div class="col-12 col-lg-10 col-xl-8">
        <h1><a href="/">How is NYC Parking Enforcement?</a></h1>
        <p class="hide-render">Is NYPD Traffic's parking enforcement consistent and rigerous on your block? <a href="/">Check</a>!</p>
        <p class="fw-light hide-render">Enforcement of parking regulations should be consistent and rigorous.</p>
        </div>
    </div>


    <div class="row">
       <div class="col-12 col-lg-8 bg-white rounded-3 pt-2">

        <form>
        <div class="mb-2">
            <label for="precinct-select">Precinct</label>
            <select id="precinct-select">
                <option value="1"> 1 Manhattan - 16 Ericsson Place</option>
                <option value="5"> 5 Manhattan - 19 Elizabeth Street</option>
                <option value="6"> 6 Manhattan - 233 West 10 Street</option>
                <option value="7"> 7 Manhattan - 19 Pitt Street</option>
                <option value="9"> 9 Manhattan - 321 East 5 Street</option>
                <option value="10"> 10 Manhattan - 230-232 West 20 Street</option>
                <option value="13"> 13 Manhattan - 230 East 21 Street</option>
                <option value="14"> 14 Manhattan - 357 West 35 Street</option>
                <option value="17"> 17 Manhattan - 167 East 51 Street</option>
                <option value="18"> 18 Manhattan - 306 West 54 Street</option>
                <option value="19"> 19 Manhattan - 153 East 67 Street</option>
                <option value="20"> 20 Manhattan - 120 West 82 Street</option>
                <option value="23"> 23 Manhattan - 164 East 102 Street</option>
                <option value="24"> 24 Manhattan - 151 West 100 Street</option>
                <option value="25"> 25 Manhattan - 120 East 119 Street</option>
                <option value="26"> 26 Manhattan - 520 West 126 Street</option>
                <option value="28"> 28 Manhattan - 2271-2289 8 Avenue</option>
                <option value="30"> 30 Manhattan - 451 West 151 Street</option>
                <option value="32"> 32 Manhattan - 250 West 135 Street</option>
                <option value="33"> 33 Manhattan - 2207 Amsterdam Avenue</option>
                <option value="34"> 34 Manhattan - 4295 Broadway</option>
                <option value="40"> 40 Bronx - 257 Alexander Avenue</option>
                <option value="41"> 41 Bronx - 1035 Longwood Avenue</option>
                <option value="42"> 42 Bronx - 830 Washington Avenue</option>
                <option value="43"> 43 Bronx - 900 Fteley Avenue</option>
                <option value="44"> 44 Bronx - 2 East 169 Street</option>
                <option value="45"> 45 Bronx - 2877 Barkley Avenue</option>
                <option value="46"> 46 Bronx - 2120 Ryer Avenue</option>
                <option value="47"> 47 Bronx - 4111 Laconia Avenue</option>
                <option value="48"> 48 Bronx - 450 Cross Bronx Expressway SR South</option>
                <option value="49"> 49 Bronx - 2121 Eastchester Road</option>
                <option value="50"> 50 Bronx - 3450 Kingsbridge Avenue</option>
                <option value="52"> 52 Bronx - 3016 Webster Avenue</option>
                <option value="60"> 60 Brooklyn - 2951 West 8 Street</option>
                <option value="61"> 61 Brooklyn - 2575 Coney Island Avenue</option>
                <option value="62"> 62 Brooklyn - 1925 Bath Avenue</option>
                <option value="63"> 63 Brooklyn - 1844 Brooklyn Avenue</option>
                <option value="66"> 66 Brooklyn - 5822 16 Avenue</option>
                <option value="67"> 67 Brooklyn - 2820 Snyder Avenue</option>
                <option value="68"> 68 Brooklyn - 333 65 Street</option>
                <option value="69"> 69 Brooklyn - 9720 Foster Avenue</option>
                <option value="70"> 70 Brooklyn - 154 Lawrence Avenue</option>
                <option value="71"> 71 Brooklyn - 421 Empire Boulevard</option>
                <option value="72"> 72 Brooklyn - 830 4 Avenue</option>
                <option value="73"> 73 Brooklyn - 1470 East New York Avenue</option>
                <option value="75"> 75 Brooklyn - 1000 Sutter Avenue</option>
                <option value="76"> 76 Brooklyn - 191 Union Street</option>
                <option value="77"> 77 Brooklyn - 127 null</option>
                <option value="78"> 78 Brooklyn - 65 6 Avenue</option>
                <option value="79"> 79 Brooklyn - 263-275 Tompkins Avenue</option>
                <option value="81"> 81 Brooklyn - 30 Ralph Avenue</option>
                <option value="83"> 83 Brooklyn - 480 Knickerbocker Avenue</option>
                <option value="84"> 84 Brooklyn - 301 Gold Street</option>
                <option value="88"> 88 Brooklyn - 298 Classon Avenue</option>
                <option value="90"> 90 Brooklyn - 211 Union Avenue</option>
                <option value="94"> 94 Brooklyn - 100 Meserole Avenue</option>
                <option value="100"> 100 Queens - 92-24 Rockaway Beach Boulevard</option>
                <option value="101"> 101 Queens - 16-12 Mott Avenue</option>
                <option value="102"> 102 Queens - 87-34 118 Street</option>
                <option value="103"> 103 Queens - 168-02 91 Avenue</option>
                <option value="104"> 104 Queens - 64-02 Catalpa Avenue</option>
                <option value="105"> 105 Queens - 92-08-92-18 222 Street</option>
                <option value="106"> 106 Queens - 103-53 101 Street</option>
                <option value="107"> 107 Queens - 71-01 Parsons Boulevard</option>
                <option value="108"> 108 Queens - 5-47 50 Avenue</option>
                <option value="109"> 109 Queens - 37-05 Union Street</option>
                <option value="110"> 110 Queens - 94-41 43 Avenue</option>
                <option value="111"> 111 Queens - 45-06 215 Street</option>
                <option value="112"> 112 Queens - 68-40 Austin Street</option>
                <option value="113"> 113 Queens - 167-02 Baisley Boulevard</option>
                <option value="114"> 114 Queens - 34-16 Astoria Boulevard South</option>
                <option value="115"> 115 Queens - 92-15 Northern Boulevard</option>
                <option value="120"> 120 Staten Island - 78 Richmond Terrace</option>
                <option value="121"> 121 Staten Island - 970 Richmond Avenue</option>
                <option value="122"> 122 Staten Island - 2320 Hylan Boulevard</option>
                <option value="123"> 123 Staten Island - 116 Main Street</option>
            </select>
        </div>
        <!-- <div class="mb-2">
            <label for="date-select">Date</label>
            <input type="date" id="date-select" min="2023-01-01" max="2024-02-23" value="2024-01-01">
        </div> -->
        <div class="row bg-light pt-3 rounded-bottom-3">
            <div class="mb-2">
                <button id="query-button" type="submit" class="btn btn-info">Search</button>
            </div>
        </div>
        </form>
    </div>
</div>

<div id="report-data" class="row mb-5"></div>

<div class="row mb-2 text-muted fw-light">
    <div class="col-lg-8">
        <p>Methodlogy: Streets with less than 3 summonses issued are excluded from street selection. Records that are missing a street, violation_county, or have future issue_date are excluded.</p>
    </div>
</div>
<div class="row">
    <footer>
        <p>Made with ❤️ by <a href="https://jehiah.cz/">@jehiah</a>.</p>
        <p>Data from <a href="https://data.cityofnewyork.us/City-Government/Parking-Violations-Issued-Fiscal-Year-2024/pvqr-7yc4">NYC Open Data</a></p>
    </footer>
</div>

</div>


<script type="module">
    // var utc = require('dayjs/plugin/utc')
    // dayjs.extend(utc)
    import FYCalendar from "./static/fy_calendar.js"
    import Punchcard from "./static/punchcard.js"


    const parseDate = d3.utcParse("%Y-%m-%d")
    const FYLookup = {
      "FY2024": {
        "dataset":"pvqr-7yc4", 
        "start": parseDate("2023-07-01"),
        "end": {
            "P":parseDate("2024-01-16"),
            "T":parseDate("2024-01-28"),
            "S":parseDate("2024-01-30")
        }
      },
      "FY2023": {
        "dataset":"869v-vr48", 
        "start": parseDate("2022-07-01"),
        "end": parseDate("2023-06-30")
      },
      "FY2022": {
        "dataset":"pvqr-7yc4",
        "start": parseDate("2022-07-01"),
        "end": parseDate("2023-07-01")
      },
      "FY2021": {
        "dataset":"7mxj-7a6y",
        "start": parseDate("2021-07-01"),
        "end": parseDate("2022-06-30")
      }
    }
    const FY = FYLookup["FY2024"]

    const ViolationCodes = {
        "1":"FAILURE TO DISPLAY BUS PERMIT",
        "2":"NO OPERATOR NAM/ADD/PH DISPLAY",
        "3":"UNAUTHORIZED PASSENGER PICK-UP",
        "4":"BUS PARKING IN LOWER MANHATTAN",
        "5":"BUS LANE VIOLATION",
        "6":"OVERNIGHT TRACTOR TRAILER PKG",
        "7":"FAILURE TO STOP AT RED LIGHT",
        "8":"IDLING",
        "9":"OBSTRUCTING TRAFFIC/INTERSECT",
        "10":"NO STOPPING-DAY/TIME LIMITS",
        "11":"NO STANDING-HOTEL LOADING",
        "12":"MOBILE BUS LANE VIOLATION",
        "13":"NO STANDING-TAXI STAND",
        "14":"NO STANDING-DAY/TIME LIMITS",
        "15":"NO STANDING-OFF-STREET LOT",
        "16":"NO STANDING-EXC. TRUCK LOADING",
        "17":"NO STANDING-EXC. AUTH. VEHICLE",
        "18":"NO STANDING-BUS LANE",
        "19":"NO STANDING-BUS STOP",
        "20":"NO PARKING-DAY/TIME LIMITS",
        "21":"NO PARKING-STREET CLEANING",
        "22":"NO STAND TAXI/FHV RELIEF STAND",
        "23":"NO PARKING-TAXI STAND",
        "24":"NO PARKING-EXC. AUTH. VEHICLE",
        "25":"NO STANDING-COMMUTER VAN STOP",
        "26":"NO STANDING-FOR HIRE VEH STND",
        "27":"NO PARKING-EXC. DSBLTY PERMIT",
        "28":"OVERTIME STANDING DP",
        "29":"ALTERING INTERCITY BUS PERMIT",
        "30":"NO STOP/STANDNG EXCEPT PAS P/U",
        "31":"NO STANDING-COMM METER ZONE",
        "32":"OT PARKING-MISSING/BROKEN METR",
        "33":"MISUSE PARKING PERMIT",
        "34":"EXPIRED METER",
        "35":"SELLING/OFFERING MCHNDSE-METER",
        "36":"PHTO SCHOOL ZN SPEED VIOLATION",
        "37":"EXPIRED MUNI METER",
        "38":"FAIL TO DSPLY MUNI METER RECPT",
        "39":"OVERTIME PKG-TIME LIMIT POSTED",
        "40":"FIRE HYDRANT",
        "41":"MISCELLANEOUS",
        "42":"EXPIRED MUNI MTR-COMM MTR ZN",
        "43":"EXPIRED METER-COMM METER ZONE",
        "44":"PKG IN EXC. OF LIM-COMM MTR ZN",
        "45":"TRAFFIC LANE",
        "46":"DOUBLE PARKING",
        "47":"DOUBLE PARKING-MIDTOWN COMML",
        "48":"BIKE LANE",
        "49":"EXCAVATION-VEHICLE OBSTR TRAFF",
        "50":"CROSSWALK",
        "51":"SIDEWALK",
        "52":"INTERSECTION",
        "53":"SAFETY ZONE",
        "54":"PCKP DSCHRGE IN PRHBTD ZONE",
        "55":"ELEVATED/DIVIDED HIGHWAY/TUNNL",
        "56":"DIVIDED HIGHWAY",
        "57":"BLUE ZONE",
        "58":"MARGINAL STREET/WATER FRONT",
        "59":"ANGLE PARKING-COMM VEHICLE",
        "60":"ANGLE PARKING",
        "61":"WRONG WAY",
        "62":"BEYOND MARKED SPACE",
        "63":"NIGHTTIME STD/ PKG IN A PARK",
        "64":"NO STANDING EXCP D/S",
        "65":"OVERTIME STDG D/S",
        "66":"DETACHED TRAILER",
        "67":"PEDESTRIAN RAMP",
        "68":"NON-COMPLIANCE W/ POSTED SIGN",
        "69":"FAIL TO DISP. MUNI METER RECPT",
        "70":"REG. STICKER-EXPIRED/MISSING",
        "71":"INSP. STICKER-EXPIRED/MISSING",
        "72":"INSP STICKER-MUTILATED/C'FEIT",
        "73":"REG STICKER-MUTILATED/C'FEIT",
        "74":"FRONT OR BACK PLATE MISSING",
        "75":"NO MATCH-PLATE/STICKER",
        "76":"VIN OBSCURED",
        "77":"PARKED BUS-EXC. DESIG. AREA",
        "78":"NGHT PKG ON RESID STR-COMM VEH",
        "79":"UNAUTHORIZED BUS LAYOVER",
        "80":"MISSING EQUIPMENT",
        "81":"NO STANDING EXCP DP",
        "82":"COMML PLATES-UNALTERED VEHICLE",
        "83":"IMPROPER REGISTRATION",
        "84":"PLTFRM LFTS LWRD POS COMM VEH",
        "85":"STORAGE-3HR COMMERCIAL",
        "86":"MIDTOWN PKG OR STD-3HR LIMIT",
        "87":"FRAUDULENT USE PARKING PERMIT",
        "88":"UNALTERED COMM VEH-NME/ADDRESS",
        "89":"NO STD(EXC TRKS/GMTDST NO-TRK)",
        "90":"VEH-SALE/WSHNG/RPRNG/DRIVEWAY",
        "91":"VEHICLE FOR SALE(DEALERS ONLY)",
        "92":"WASH/REPAIR VEHCL-REPAIR ONLY",
        "93":"REMOVE/REPLACE FLAT TIRE",
        "96":"RAILROAD CROSSING",
        "97":"VACANT LOT",
        "98":"OBSTRUCTING DRIVEWAY",
        "99":"OTHER"
    }
    const nonParkingViolations = new Set([
        "3", "7", "8", "29", "33", "36", "41", "54", "70","71", "72", "73", "74", "75", "76", "80", "82", "83", "84", "87", "88", "91", "97", "99"
    ])

    const agencyLookup = {
        "P": "Police Department",
        "T": "Traffic",
        "S": "Sanitation",
        "K": "Parks",
    }

    const boroughLookup = {
        "Brooklyn": "bk",
        "Queens": "qn",
        "Manhattan": "ny",
        "Bronx": "bx",
        "Staten Island": "si",
    }

const dtFormat = new Intl.DateTimeFormat("en-US");

function getData(query) {
    return Promise.all([
    fetch("https://data.cityofnewyork.us/resource/"+FYLookup["FY2024"].dataset+".csv?$select=plate_id,registration_state,violation_code,issuing_agency,issue_date,street_name,house_number,intersecting_street,violation_time,summons_number&$limit=100000"+query),
    fetch("https://data.cityofnewyork.us/resource/"+FYLookup["FY2023"].dataset+".csv?$select=plate_id,registration_state,violation_code,issuing_agency,issue_date,street_name,house_number,intersecting_street,violation_time,summons_number&$limit=100000"+query)
    ]).then(results => Promise.all(results.map(r => r.text())))
    .then(results => {
        const d1 = d3.csvParse(results[0])
        const d2 = d3.csvParse(results[1])
        d1.push(...d2)
        return d1
    })
}

const enOrdinalRules = new Intl.PluralRules("en-US", { type: "ordinal" });

const suffixes = new Map([
  ["one", "st"],
  ["two", "nd"],
  ["few", "rd"],
  ["other", "th"],
]);
const formatOrdinals = (n) => {
//   const v = parseInt(n, 10)
  const rule = enOrdinalRules.select(n);
  const suffix = suffixes.get(rule);
  return `${n}${suffix}`;
};

// function to query NYC Open Data and render D3 calendar chart
function queryNYCOpenData() {
    const precinctEl = document.getElementById("precinct-select")
    const precinct = precinctEl.value

    const issuingAgency = "P"
    let end = FY.end[issuingAgency]
    dayjs.extend(dayjs_plugin_utc)
    let startDate = dayjs(end).utcOffset(0).date(1).subtract(11, 'month').toDate()

    document.getElementById("report-data").innerHTML = ''
    const el = document.createElement("div");
    el.className = "col-12 my-2 py-2 bg-white";
    document.getElementById("report-data").appendChild(el)
    const heading = document.createElement("h2")
    const dateFormat = d3.utcFormat("%Y-%m-%d")
    heading.innerText = `Violations written by Police in ${formatOrdinals(precinct)} Precinct between ${dateFormat(startDate)} and ${dateFormat(end)}`
    // heading.class="m-3"
    el.appendChild(heading)


    let spinner = document.createElement("div")
    spinner.className = "spinner-border m-5"
    spinner.setAttribute("role", "status")
    // spinner.innerText = "Loading ..." FIXME: invalid html structure; see https://getbootstrap.com/docs/5.2/components/spinners/
    el.appendChild(spinner)

    let filters = [
       `issue_date between '${dateFormat(startDate)}T00:00:00' and '${dateFormat(end)}T23:59:59'`
    ];
    let displayFilters = [
      `issue_date between ${dateFormat(startDate)} and ${dateFormat(end)}`,
    ];

    filters.push(`violation_precinct = ${precinct}`)
    displayFilters.push(`violation_precinct = ${precinct}`)
    filters.push(`issuing_agency='${issuingAgency}'`)
    displayFilters.push(`issuing_agency='${issuingAgency}' // ${agencyLookup[issuingAgency]}`)
    const queryString = `&$where=${filters.join(" AND ")}`


    getData(queryString).then(function(data) {
        // parse date strings to Date objects
        const parseDate = d3.utcParse("%Y-%m-%dT%H:%M:%S.%L");
        const parseTime = d3.utcParse("%I%M%p");
        const dtFormatHour = new Intl.DateTimeFormat("en-US", {
            hour: "numeric",
            minute: "numeric",
            // dayPeriod: "narrow",
            hour12: true,
            timeZone: "UTC",
        });
        if (data.length == 100000) {
            alert("⚠️ The Open Data Query returned the maximum results. Data is truncated. Narrow the street selection for complete results.")
        }
        data.forEach(function(d) {
            d.issue_date = parseDate(d.issue_date);
            d.count = 1
            // d.issue_date_dayonly = parseDate(d.issue_date); // day granularity (no time component)

            let violation_time = parseTime(d.violation_time + "M")
            if (violation_time != null ) {
                d.issue_date.setUTCHours(violation_time.getUTCHours())
                d.issue_date.setUTCMinutes(violation_time.getUTCMinutes())
                d.violation_time = dtFormatHour.format(d.issue_date)
            }
        })

        let seenSummons = {}
        data = data.filter( d=> { 
            if (d.issue_date < startDate || d.issue_date > end) { return false; }
            // dedupe across two fiscal year datasets - they have overlap
            const key = d.summons_number + ' ' +  d.violation_code
            if (seenSummons[key])  return false
            seenSummons[key] = true
            return true
        });
        seenSummons = null

        data.sort((a, b) => d3.ascending(a.issue_date, b.issue_date))
        const parkingData = data.filter(d => !nonParkingViolations.has(d.violation_code))
        const nonParkingData = data.filter(d => nonParkingViolations.has(d.violation_code))
        // console.log("matching data", data.length, data.slice(0,10))

        // group data by issue_date
        const groupByDate = d3.rollups(parkingData, v => v.length, d => d3.utcDay(d.issue_date));
        let topDate = undefined;
        let topDateCount = undefined;
        if (groupByDate.length > 0) {
            topDate = d3.greatest(groupByDate, ([, v]) => v)[0];
            topDateCount = d3.greatest(groupByDate, ([, v]) => v)[1];
        }

        const violationsByDay = groupByDate.map(([k,v]) => {return {date:k, count:v}})
        const groupOfDate = violationsByDay.map(d => d.date.toDateString())
        // extend to include zero counts for empty days
        violationsByDay.push(... d3.utcDay.range(startDate, end).filter(d => {return groupOfDate.indexOf(d.toDateString()) == -1}).map(k => { return {date:k, count:0}}))

        // const groupByAgency = d3.rollups(parkingData, v => v.length, d => d.issuing_agency);
        const groupByAgency = []
        const groupByViolation = d3.rollups(parkingData, v => v.length, d => d.violation_code);
        let topViolation = undefined
        let topViolationCount = undefined
        if (groupByViolation.length >= 1) {
            topViolation = d3.greatest(groupByViolation, ([, v]) => v)[0];
            topViolationCount = d3.greatest(groupByViolation, ([, v]) => v)[1];
        }
        const nonParkingGroupByViolation = d3.rollups(nonParkingData, v => v.length, d => d.violation_code);
        let nonParkingTopViolation = undefined
        let nonParkingTopViolationCount = undefined
        if (nonParkingGroupByViolation.length >= 1) {
            nonParkingTopViolation = d3.greatest(nonParkingGroupByViolation, ([, v]) => v)[0];
            nonParkingTopViolationCount = d3.greatest(nonParkingGroupByViolation, ([, v]) => v)[1];
        }

        const dtFormatLong = new Intl.DateTimeFormat("en-US", {
            weekday: "short",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            timeZone: "UTC",
        });

        const maxVal = d3.max(violationsByDay, d=> d.count)

        let summary = el.appendChild(document.createElement("p"))
        summary.className="summary"
        let summaryParagraphs = [
            `<mark>${parkingData.length}</mark> parking violations were issued`,
            ` by <mark>${agencyLookup[issuingAgency]}</mark> in ${formatOrdinals(precinct)} Precinct`,
            ` on <mark>${groupByDate.length}</mark> of <mark>${violationsByDay.length}</mark> days between 
          <mark>${d3.utcFormat("%b %d %Y")(startDate)}</mark> and <mark>${d3.utcFormat("%b %d %Y")(end)}</mark> 
          (<mark>${d3.format("0.1%")(groupByDate.length/violationsByDay.length)}</mark> of the days)`,
          parkingData.length > 1 ? ` an average of <mark>${d3.format("0.1f")(parkingData.length / groupByDate.length)}</mark> per day` : "",
          `.`
        ]

        summary.innerHTML = summaryParagraphs.join("")


        summary = el.appendChild(document.createElement("p"))
        summary.className="summary"
        summaryParagraphs = [
        //   `There were <mark>${data.length}</mark> violations recorded`,
        //   ` for street <mark>${street}</mark> `,
        //   ` for addresses <mark>${houseStart}-${houseEnd}</mark>`,
        //   (validIntersections.length == 0 ? "" :` or <mark>${validIntersections.length}</mark> intersecting streets`),
        //   `. `
        ]

        if (parkingData.length > 0 ) {
            if (groupByDate.length > 1) {
                summaryParagraphs.push(`<mark>${dtFormatLong.format(topDate)}</mark> had the most parking violations issued (<mark>${topDateCount}</mark>). `)
            }
            summaryParagraphs.push(`The most common parking violation was <mark>${ViolationCodes[topViolation]}</mark> (issued <mark>${topViolationCount}</mark> times). `)
        }
        if (nonParkingData.length > 0) {
            summaryParagraphs.push(`There ${nonParkingData.length == 1 ? "was":"were"} <mark>${nonParkingData.length}</mark> non-parking violations issued. `)
            summaryParagraphs.push(`The most common non-parking violation was <mark>${ViolationCodes[nonParkingTopViolation]}</mark> (issued <mark>${nonParkingTopViolationCount}</mark> times). `)
        }

        // TODO: use the filter not the results
        // if (groupByAgency.length > 1) {
        //     groupByAgency.sort((a, b) => d3.descending(a[1], b[1])).forEach(([agency, count]) => {
        //         summaryParagraphs.push(`<mark>${agencyLookup[agency]}</mark> issued <mark>${count}</mark> parking violations (<mark>${d3.format("0.1%")(count/parkingData.length)}</mark>). `)
        //     })
        // }

        summary.innerHTML = summaryParagraphs.join("")


        let container = document.createElement("div")
        container.className = "calendar-chart"
        el.appendChild(container)

        let cellSize = 14
        const width = container.offsetWidth - parseFloat(getComputedStyle(container).paddingLeft, 10)- parseFloat(getComputedStyle(container).paddingRight, 10)
        if (width > 900) {
            cellSize = 16
        }

        // create calendar chart
        const titleDateFormat = d3.utcFormat("%A %b %d %Y");
        const calendarChart = FYCalendar(violationsByDay, {
            x: d => d.date,
            y: d => d.count,
            Xmin: startDate,
            Xmax: end,
            // color: d3.scaleSequential([0, maxVal], d3.interpolateSpectral),
            color: d3.scaleSequential([1, maxVal], d3.interpolateHcl("#fafa6e", "#2A4858")),
            emptyColor: "#f3f3f3",
            weekday:"sunday",
            // width:900,
            // yFormat: "%d",
            cellSize: cellSize,
            cellPadding: 2,
            monthPadding: 17 + 2,
            formatMonth: "%b %Y",
            // title: d => d.count
            // todo: https://medium.com/@kj_schmidt/show-data-on-mouse-over-with-d3-js-3bf598ff8fc2
            title: d => d.count > 0 ? `${titleDateFormat(d.date)}: ${d.count} violations` : ""
        })


        // container.appendChild(Legend(
        //     calendarChart.scales.color, {
        //         title: "FY 2022-2023 Violations/day",
        //         width: 500,
        //     }
        // ));
        el.removeChild(spinner)


        container = document.createElement("div")
        container.className = "calendar-chart mb-4"
        container.appendChild(calendarChart)
        el.appendChild(container)

        if (parkingData.length > 0) {
            // create calendar chart
            const punchcard = Punchcard(parkingData, {
                x: d => d.issue_date,
                y: d => d.count,
                // color: d3.scaleSequential([0, maxVal], d3.interpolateSpectral),
                color: d3.interpolateHcl("rgb(71, 184, 135)", "#2A4858"),
                emptyColor: "#aaa",
                weekday:"sunday",
                // width:(25 + (22+1) * 24),
                // yFormat: "%d",
                cellSize: 22,
                cellPadding: 1,
                // formatMonth: "%b %Y",
                // title: d => d.count
                // todo: https://medium.com/@kj_schmidt/show-data-on-mouse-over-with-d3-js-3bf598ff8fc2
                // title: d => d.count > 0 ? `${dtFormat.format(d.date)}: ${d.count}` : ""
            })
            container = document.createElement("div")
            container.className = "punchcard-chart mb-4"
            container.appendChild(punchcard)
            el.appendChild(container)
        }

        // {{if .SavePreview }}
        // html2canvas(document.body, {
        //     backgroundColor: "#ffd900",
        //     width: 800,
        //     height: 400,
        //     windowWidth: 800,
        //     widowHeight: 400,
        //     onclone: d => {
        //         // console.log(d);
        //         d.getElementsByTagName("body")[0].className="render"
        //     },
        //     ignoreElements: e => e.classList.contains("hide-render")
        // }).then(function(canvas) {
        //     canvas.toBlob((blob) => {
        //         fetch('', {
        //             method: "put",
        //             headers: {
        //                 'Content-type': 'image/png'
        //             },
        //             body: blob
        //         })
        //     })
        // });
        // {{end}}


        // container = document.createElement("div")
        // container.className = "agency-chart"
        // container.appendChild(BarChart(groupByAgency, {
        //     x: d => d[1],
        //     y: d => d[0],
        //     //   yDomain: d3.groupSort(alphabet, ([d]) => -d.frequency, d => d.letter), // sort by descending frequency
        //     //   xFormat: "%",
        //     xLabel: "Frequency →",
        //     //   width,
        //     color: "steelblue"
        // }))
        // el.appendChild(container)

        let debugQuery = el.appendChild(document.createElement("div"))
        debugQuery.className = "query mb-2 lh-sm"
        debugQuery.innerHTML=displayFilters.map(d=>`<code>${d}</code><br>`).join("\n")


        const table = el.appendChild(document.createElement("table"))
        table.className = "table table-sm table-xsm table-striped mb-2 p-2"

        const thead = table.appendChild(document.createElement("thead"))
        const tr = thead.appendChild(document.createElement("tr"))
        tr.className = "bg-dark text-light"
        tr.appendChild(document.createElement("th")).innerText = "Date"
        tr.appendChild(document.createElement("th")).innerText = "Summons"
        tr.appendChild(document.createElement("th")).innerText = "License"
        tr.appendChild(document.createElement("th")).innerText = "Location"
        let cell = tr.appendChild(document.createElement("th"))
        cell.className = groupByAgency.length > 1 ? "agencies": "agency"
        cell.innerText = "Agency"
        tr.appendChild(document.createElement("th")).innerText = "Violation"

        const tbody = table.appendChild(document.createElement("tbody"))
        data.forEach(d => {
            const tr = tbody.appendChild(document.createElement("tr"))
            tr.className = nonParkingViolations.has(d.violation_code) ? "non-parking-violation" : "parking-violation"
            tr.appendChild(document.createElement("td")).innerText = dtFormat.format(d.issue_date) + " " + d.violation_time // TODO format
            let cell = tr.appendChild(document.createElement("td"))
            cell.className = "summons font-monospace"
            let a = cell.appendChild(document.createElement("a"))
            a.href = "/summons?" + (new URLSearchParams({"number":d.summons_number})).toString()
            a.rel = "nofollow"
            a.innerText = d.summons_number

            cell = tr.appendChild(document.createElement("td"))
            cell.innerText = d.registration_state + ":" + d.plate_id 
            cell.className = "font-monospace"
            tr.appendChild(document.createElement("td")).innerText = d.house_number + ' ' + d.street_name + (d.intersecting_street == "" ? "":  " @ " + d.intersecting_street)
            cell = tr.appendChild(document.createElement("td"))
            cell.className = groupByAgency.length > 1 ? "agencies": "agency"
            cell.innerText = agencyLookup[d.issuing_agency]
            tr.appendChild(document.createElement("td")).innerText = ViolationCodes[d.violation_code]
        })
        el.appendChild(table)
        return false;
    });

}
function nullString(s) {
    return s === null ? "" : s
}
function defaultString(s, d) {
    return s === "" ? d : s
}

function submitForm(evt) {
    evt.preventDefault();
    var qs = new URLSearchParams()
    qs.set("precinct", document.getElementById("precinct-select").value)
    const l = qs.toString();
    console.log('qs', l)
    history.pushState(null, document.title, l.length == 0 ? window.location.pathname : window.location.pathname + "?" + l)
    queryNYCOpenData()
}

function bootstrap() {
    document.getElementById("query-button").addEventListener("click", submitForm);

    const urlSearchParams = new URLSearchParams(window.location.search)
    let urlPrecinct = nullString(urlSearchParams.get("precinct"))
    document.getElementById("precinct-select").value = defaultString(urlPrecinct, "1")
    if (urlPrecinct != "") {
        queryNYCOpenData()
    }
}
bootstrap()



</script>
</body>
</html>
